<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netcoreapp2.1</TargetFramework>
    <GenerateAssemblyInfo>true</GenerateAssemblyInfo>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <PublishTrimmed>true</PublishTrimmed>
  </PropertyGroup>
  <ItemGroup>
    <Compile Include="Collection.fs" />
    <Compile Include="PSCmdletExtensions.fs" />
    <Compile Include="RepairEncodingCommand.fs" />
    <Compile Include="TestUtf8SignatureCommand.fs" />
    <Compile Include="AddUtf8SignatureCommand.fs" />
    <Compile Include="RemoveUtf8SignatureCommand.fs" />
    <Compile Include="TestFinalNewlineCommand.fs" />
    <Compile Include="TestUtf8EncodingCommand.fs" />
    <Compile Include="TestTextFileCommand.fs" />
    <Compile Include="TestWindows1252Command.fs" />
    <Compile Include="TestBrokenEncodingCommand.fs" />
    <Compile Include="TestBinaryFileCommand.fs" />
    <Compile Include="GetFileEncodingCommand.fs" />
    <Compile Include="GetFileIndentsCommand.fs" />
    <Compile Include="GetFileLineEndingsCommand.fs" />
    <Compile Include="GetFileContentsInfoCommand.fs" />
    <Compile Include="GetFileEditorConfigCommand.ps1.fs" />
    <Compile Include="TestFileEditorConfigCommand.fs" />
    <Compile Include="RepairFileEditorConfigCommand.fs" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="editorconfig" Version="0.12.2" />
    <PackageReference Include="PowerShellStandard.Library" Version="5.1.1" />
  </ItemGroup>
  <ItemGroup>
    <None Include="$(MSBuildProjectName).psd1" Pack="true" CopyToOutputDirectory="Always" />
    <None Include="$(MSBuildProjectName).dll-Help.xml" Pack="true" CopyToOutputDirectory="Always" />
  </ItemGroup>
  <Target Name="SetAssemblyVersion" BeforeTargets="GetAssemblyVersion">
    <Exec Command='pwsh -noni -nop -c "Import-LocalizedData -BindingVariable m -FileName $(MSBuildProjectName); (gv m -va).ModuleVersion"'
        ConsoleToMSBuild="true" IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="Version" />
    </Exec>
  </Target>
  <Target Name="doc" DependsOnTargets="Documentation" />
  <Target Name="Documentation" DependsOnTargets="Publish">
    <Copy SourceFiles="$(OutputPath)\publish\FSharp.Core.dll" DestinationFolder="$(OutputPath)" />
    <Copy SourceFiles="$(OutputPath)\publish\EditorConfig.Core.dll" DestinationFolder="$(OutputPath)" />
    <Exec Command='pwsh -noni -nop -c "Import-Module (Resolve-Path $(OutputPath)*.psd1); New-MarkdownHelp -Module $(MSBuildProjectName) -OutputFolder ..\..\docs -ea 0; Update-MarkdownHelp ..\..\docs; New-ExternalHelp ..\..\docs -OutputPath . -Force"'
        IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true" />
  </Target>
  <Target Name="test" DependsOnTargets="Pester" />
  <Target Name="Pester" DependsOnTargets="Publish" Condition="'$(Configuration)' == 'Debug'">
    <Copy SourceFiles="$(OutputPath)\publish\FSharp.Core.dll" DestinationFolder="$(OutputPath)" />
    <Copy SourceFiles="$(OutputPath)\publish\EditorConfig.Core.dll" DestinationFolder="$(OutputPath)" />
    <Exec Command='pwsh -noni -nop -c "cd ..\..; Invoke-Pester"' IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true" />
  </Target>
  <ItemGroup>
    <PSModulePath Include="$(PSModulePath)" Exclude="C:\Program Files\**;C:\Windows\**;C:\ProgramData\chocolatey\**" />
  </ItemGroup>
  <Target Name="PublishModule" DependsOnTargets="Publish" Condition="'$(Configuration)' == 'Release'">
    <RemoveDir Directories="@(PSModulePath-&gt;'%(FullPath)\$(MSBuildProjectName)')" />
    <Copy SourceFiles="$(OutputPath)\publish\FSharp.Core.dll" DestinationFolder="$(OutputPath)" />
    <Copy SourceFiles="$(OutputPath)\publish\EditorConfig.Core.dll" DestinationFolder="$(OutputPath)" />
    <ItemGroup>
      <ModuleFiles Include="$(OutputPath)\*" />
    </ItemGroup>
    <Copy SourceFiles="@(ModuleFiles)" DestinationFolder="@(PSModulePath-&gt;'%(FullPath)\$(MSBuildProjectName)\$(Version)')" />
    <Exec Command='pwsh -noni -nop -c "[bool](Get-SecretInfo $(MSBuildProjectName) -Vault PowerShellGallery)"'
        ConsoleToMSBuild="true" IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="HasApiKey" />
    </Exec>
    <Error Text="To publish, first run: .\Set-ApiKey.ps1" Condition="!$(HasApiKey)" />
    <Exec Command='pwsh -nop -c "(New-Object PSCredential _,(Get-Secret $(MSBuildProjectName) -Vault PowerShellGallery)).GetNetworkCredential().Password"'
        ConsoleToMSBuild="true" IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true" Condition="$(HasApiKey)">
      <Output TaskParameter="ConsoleOutput" PropertyName="ApiKey" />
    </Exec>
    <Exec Command='pwsh -noni -nop -c "Import-Module $(MSBuildProjectName); Publish-Module -Name $(MSBuildProjectName) -NuGetApiKey $(ApiKey)"'
        IgnoreExitCode="true" IgnoreStandardErrorWarningFormat="true" Condition="$(HasApiKey)" />
  </Target>
</Project>
